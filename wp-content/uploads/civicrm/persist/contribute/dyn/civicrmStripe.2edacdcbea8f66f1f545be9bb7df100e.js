(function(e,r){var I='civicrmStripe',u=null,l=null,n,a,m=!1,c=null;window.onbeforeunload=null;if(CRM.payment.hasOwnProperty('Stripe')){return};var w={Stripe:!0};e.extend(CRM.payment,w);e(document).ajaxComplete(function(e,i,n){if(CRM.payment.isAJAXPaymentForm(n.url)){t('triggered via ajax');y()}});document.addEventListener('DOMContentLoaded',function(){t('DOMContentLoaded');y()});function y(){if(window.civicrmStripeHandleReload){t('calling existing civicrmStripeHandleReload.');window.civicrmStripeHandleReload()}};window.civicrmStripeHandleReload=function(){t('civicrmStripeHandleReload');n=CRM.payment.getBillingForm();if(typeof n.length==='undefined'||n.length===0){t('No billing form!');return};var i=C(),e=document.getElementById('card-element');if((typeof e!=='undefined')&&(e)){if(!e.children.length){t('checkAndLoad from document.ready');D()}
else{t('already loaded')}}
else{g();o('crmBillingFormReloadComplete')}};function p(e,i){t(e+': success - submitting form');var r=document.createElement('input');r.setAttribute('type','hidden');r.setAttribute('name',e);r.setAttribute('value',i.id);n.appendChild(r);R();n.submit()};function f(){for(i=0;i<a.length;++i){a[i].setAttribute('disabled',!0)};R();return n.submit()};function s(e,r){t('error: '+e);var l=document.getElementById('card-errors');l.style.display='block';l.textContent=e;n.dataset.submitted='false';if(typeof a!=='undefined'){for(i=0;i<a.length;++i){a[i].removeAttribute('disabled')}};o('crmBillingFormNotValid');if(r){d({icon:'error',text:e,title:''},'#card-element',!0)}};function v(){return{card:e('div#card-element')}};function k(){v().card.hide()};function B(){if(l!==null){t('destroying card element');l.destroy();l=null}};function E(){var e=v();if((e.card.length!==0)&&(e.card.children().length===0)){t('card element is empty');return!1};return!0};function x(){t('handle card payment');u.createPaymentMethod('card',l).then(function(i){if(i.error){s(i.error.message,!0)}
else{if(CRM.payment.getIsRecur()||CRM.payment.isEventAdditionalParticipants()||(CRM.payment.getTotalAmount()===0.0)){p('paymentMethodID',i.paymentMethod)}
else{t('Waiting for pre-auth');d({title:r('Please wait'),text:r(' while we pre-authorize your card...'),allowOutsideClick:!1,onBeforeOpen:function(){Swal.showLoading()}},'',!1);var n=CRM.url('civicrm/stripe/confirm-payment');e.post(n,{payment_method_id:i.paymentMethod.id,amount:CRM.payment.getTotalAmount().toFixed(2),currency:CRM.payment.getCurrency(CRM.vars.stripe.currency),id:CRM.vars.stripe.id,description:document.title,csrfToken:CRM.vars.stripe.csrfToken}).done(function(e){A();F(e)}).fail(function(){A();s('Unknown error',!0)})}}})};function F(e){t('handleServerResponse');if(e.error){s(e.error.message,!0)}
else if(e.requires_action){q(e)}
else{p('paymentIntentID',e.paymentIntent)}};function q(e){u.handleCardAction(e.payment_intent_client_secret).then(function(e){if(e.error){s(e.error.message,!0)}
else{p('paymentIntentID',e.paymentIntent)}})};function g(){t('New payment processor is not Stripe, clearing CRM.vars.stripe');B();e('.is_recur-section #stripe-recurring-start-date').remove();delete(CRM.vars.stripe)};function D(){if(typeof CRM.vars.stripe==='undefined'){t('CRM.vars.stripe not defined! Not a Stripe processor?');return};if(typeof Stripe==='undefined'){if(m){return};m=!0;t('Stripe.js is not loaded!');e.ajax({url:'https://js.stripe.com/v3',dataType:'script',cache:!0,timeout:5000,crossDomain:!0}).done(function(e){m=!1;t('Script loaded and executed.');h();o('crmBillingFormReloadComplete');o('crmStripeBillingFormReloadComplete')}).fail(function(){m=!1;t('Failed to load Stripe.js');S()})}
else{h();if(E()){o('crmStripeBillingFormReloadComplete')}
else{t('Failed to load payment elements');S()}}};function h(){t('loadStripeBillingBlock');var y=c;c=O();t('payment processor old: '+y+' new: '+c+' id: '+CRM.vars.stripe.id);if((c!==null)&&(c!==parseInt(CRM.vars.stripe.id))){t('not stripe');return g()};t('New Stripe ID: '+CRM.vars.stripe.id+' pubKey: '+CRM.vars.stripe.publishableKey);u=Stripe(CRM.vars.stripe.publishableKey);t('locale: '+CRM.vars.stripe.locale);var p=u.elements({locale:CRM.vars.stripe.locale});var m={base:{fontSize:'1.1em',fontWeight:'lighter'}};var d={style:m,value:{}};var s=document.getElementById('billing_postal_code-'+CRM.vars.stripe.billingAddressID);if(s){var o=document.getElementById('billing_postal_code-'+CRM.vars.stripe.billingAddressID).value;t('existing postcode: '+o);d.value.postalCode=o};v().card.removeClass();l=p.create('card',d);l.mount('#card-element');t('created new card element',l);if(s){if(document.getElementById('billing_postal_code-5').value){document.getElementById('billing_postal_code-5').setAttribute('disabled',!0)}
else{document.getElementsByClassName('billing_postal_code-'+CRM.vars.stripe.billingAddressID+'-section')[0].setAttribute('hidden',!0)}};l.addEventListener('change',function(e){L(e)});z();a=C();n.dataset.submitdontprocess='false';var r=n.querySelectorAll('[type="submit"][formnovalidate="1"], [type="submit"][formnovalidate="formnovalidate"], [type="submit"].cancel, [type="submit"].webform-previous'),i;for(i=0;i<r.length;++i){r[i].addEventListener('click',h(r[i]))};function h(e){t('adding submitdontprocess: '+e.id);n.dataset.submitdontprocess='true'};for(i=0;i<a.length;++i){a[i].addEventListener('click',R)};function R(e){if(typeof CRM.vars.stripe==='undefined'){return f()};t('clearing submitdontprocess');n.dataset.submitdontprocess='false';return b(e)};for(i=0;i<a.length;++i){a[i].removeAttribute('onclick')};T();if(CRM.payment.getIsDrupalWebform()){e('[type=submit]').click(function(){M(this.value)});n.addEventListener('keydown',function(e){if(e.code==='Enter'){M(this.value);b(e)}});e('#billingcheckbox:input').hide();e('label[for="billingcheckbox"]').hide()}};function b(l){l.preventDefault();t('submit handler');if(n.dataset.submitted==='true'){return};n.dataset.submitted='true';if((e(n).valid()===!1)||e(n).data('crmBillingFormValid')===!1){t('Form not valid');e('div#card-errors').hide();d({icon:'error',text:r('Please check and fill in all required fields!'),title:''},'#crm-container',!0);o('crmBillingFormNotValid');n.dataset.submitted='false';return!1};var s=CRM.$('#card-errors').text();if(CRM.$('#card-element.StripeElement--empty').length&&(CRM.payment.getTotalAmount()!==0.0)){t('card details not entered!');if(!s){s=r('Please enter your card details')};d({icon:'warning',text:'',title:s},'#card-element',!0);o('crmBillingFormNotValid');n.dataset.submitted='false';return!1};if(CRM.$('#card-element.StripeElement--invalid').length){if(!s){s=r('Please check your card details!')};t('card details not valid!');d({icon:'error',text:'',title:s},'#card-element',!0);o('crmBillingFormNotValid');n.dataset.submitted='false';return!1};if(!N()){return!1};if(typeof CRM.vars.stripe==='undefined'){t('Submitting - not a stripe processor');return!0};var u=parseInt(CRM.vars.stripe.id),c=null;if(CRM.payment.getIsDrupalWebform()){if(!e('input[name="submitted[civicrm_1_contribution_1_contribution_payment_processor_id]"]').length){c=u}
else{c=parseInt(n.querySelector('input[name="submitted[civicrm_1_contribution_1_contribution_payment_processor_id]"]:checked').value)}}
else{if((n.querySelector('.crm-section.payment_processor-section')!==null)||(n.querySelector('.crm-section.credit_card_info-section')!==null)){u=CRM.vars.stripe.id;if(n.querySelector('input[name="payment_processor_id"]:checked')!==null){c=parseInt(n.querySelector('input[name="payment_processor_id"]:checked').value)}}};if((c===0)||(u===null)||((c===null)&&(u===null))){t('Not a Stripe transaction, or pay-later');return f()}
else{t('Stripe is the selected payprocessor')};if(typeof CRM.vars.stripe.publishableKey==='undefined'){t('submit missing stripe-pub-key element or value');return!0};if(n.dataset.submitdontprocess==='true'){t('non-payment submit detected - not submitting payment');return!0};if(CRM.payment.getIsDrupalWebform()){if(e('#billing-payment-block').is(':hidden')){t('no payment processor on webform');return!0};var m=e('[name="submitted[civicrm_1_contribution_1_contribution_payment_processor_id]"]');if(m.length){if(m.filter(':checked').val()==='0'||m.filter(':checked').val()===0){t('no payment processor selected');return!0}}};var p=CRM.payment.getTotalAmount();if(p===0.0){t('Total amount is 0');return f()};for(i=0;i<a.length;++i){a[i].setAttribute('disabled',!0)};x();if(e('#stripe-recurring-start-date').is(':hidden')){e('#stripe-recurring-start-date').remove()};return!0};function N(){if(typeof grecaptcha==='undefined'){t('reCaptcha library not loaded');return!0};if(e(n).find('[name=g-recaptcha-response]').length===0){t('no reCaptcha on form');return!0};if(e(n).find('[name=g-recaptcha-response]').val().length>0){t('recaptcha is valid');return!0};t('recaptcha active and not valid');e('div#card-errors').hide();d({icon:'warning',text:'',title:r('Please complete the reCaptcha')},'.recaptcha-section',!0);o('crmBillingFormNotValid');n.dataset.submitted='false';return!1};function C(){var e=null;if(CRM.payment.getIsDrupalWebform()){e=n.querySelectorAll('[type="submit"].webform-submit');if(e.length===0){e=n.querySelectorAll('[type="submit"].webform-button--submit')}}
else{e=n.querySelectorAll('[type="submit"].validate')};if(e.length===0){t('No submit button found!')};return e};function L(t){if(t.empty){e('div#card-errors').hide()}
else if(t.error){s(t.error.message,!1)}
else if(t.complete){e('div#card-errors').hide();var i=document.getElementById('billing_postal_code-'+CRM.vars.stripe.billingAddressID);if(i){i.value=t.value.postalCode}}};function T(){cividiscountElements=n.querySelectorAll('input#discountcode');var e=function(e){if(e.code==='Enter'){e.preventDefault();t('adding submitdontprocess');n.dataset.submitdontprocess='true'}};for(i=0;i<cividiscountElements.length;++i){cividiscountElements[i].addEventListener('keydown',e)}};function R(){e('div#priceset input[type="checkbox"], fieldset.crm-profile input[type="checkbox"]').each(function(){CRM.$(this).attr('name',CRM.$(this).attr('name')+'['+CRM.$(this).attr('id').split('_').pop()+']');CRM.$(this).removeAttr('required');CRM.$(this).removeClass('required');CRM.$(this).removeAttr('aria-required')})};function z(){e('div.label span.crm-marker').each(function(){e(this).closest('div').next('div').find('input').addClass('required')});e('div#priceset input[type="checkbox"], fieldset.crm-profile input[type="checkbox"]').each(function(){e(this).attr('name',e(this).attr('name').split('[').shift())});var i=e('#is_for_organization');if(i.length){r();i.on('change',function(){r()})};function r(){if(i.is(':checked')){e('#onBehalfOfOrg select.crm-select2').removeClass('crm-no-validate')}
else{e('#onBehalfOfOrg select.crm-select2').addClass('crm-no-validate')}};var t=e(n).validate();t.settings.errorClass='crm-inline-error alert-danger';t.settings.ignore='.select2-offscreen, [readonly], :hidden:not(.crm-select2), .crm-no-validate';t.settings.ignoreTitle=!0;e.validator.methods.email=function(e,t){return this.optional(t)||/^[a-zA-Z0-9.!#$%&'*+\/=?^_`{|}~-]+@[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)*$/.test(e)}};function M(e){var t=null;if(document.getElementById('action')!==null){t=document.getElementById('action')}
else{t=document.createElement('input')};t.setAttribute('type','hidden');t.setAttribute('name','op');t.setAttribute('id','action');t.setAttribute('value',e);n.appendChild(t)};function O(){if((typeof n==='undefined')||(!n)){n=CRM.payment.getBillingForm();if(!n){return null}};var e=n.querySelector('input[name="payment_processor_id"]:checked');if(e!==null){return parseInt(e.value)}
else{e=n.querySelector('select[name="payment_processor_id"]');if(e!==null){return parseInt(e.value)}};return null};function t(e){CRM.payment.debugging(I,e)};function o(i){t('Firing Event: '+i);e(n).trigger(i)};function S(){o('crmBillingFormReloadFailed');k();s(r('Could not load payment element - Is there a problem with your network connection?'),!0)};function d(t,i,n){if(typeof Swal==='function'){if(i.length>0){t.onAfterClose=function(){window.scrollTo(e(i).position())}};Swal.fire(t)}
else if(n){window.alert(t.title+' '+t.text)}};function A(){if(typeof Swal==='function'){Swal.close()}}}(CRM.$,CRM.ts('com.drastikbydesign.stripe')));